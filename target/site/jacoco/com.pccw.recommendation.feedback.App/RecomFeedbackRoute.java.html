<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RecomFeedbackRoute.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">recommendation_feedback</a> &gt; <a href="index.source.html" class="el_package">com.pccw.recommendation.feedback.App</a> &gt; <span class="el_source">RecomFeedbackRoute.java</span></div><h1>RecomFeedbackRoute.java</h1><pre class="source lang-java linenums">package com.pccw.recommendation.feedback.App;

import java.util.List;

import javax.sql.DataSource;

import org.apache.camel.Exchange;
import org.apache.camel.Processor;
import org.apache.camel.builder.RouteBuilder;
import org.apache.camel.model.rest.RestBindingMode;
import org.apache.camel.model.rest.RestParamType;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Component;

import com.pccw.recommendation.feedback.model.RecomFeedback;
import com.pccw.recommendation.feedback.model.RecomFeedbackPost;
import com.pccw.recommendation.feedback.service.RecomFeedbackService;
import com.pccw.recommendation.feedback.service.RecomFeedbackServiceImpl;
import com.pccw.recommendation.feedback.util.ErrorResponseUtil;

@Component
<span class="nc" id="L23">public class RecomFeedbackRoute extends RouteBuilder {</span>

	@Autowired
	DataSource dataSource;

	public DataSource getDataSource() {
<span class="nc" id="L29">		return dataSource;</span>
	}

	public void setDataSource(DataSource dataSource) {
<span class="nc" id="L33">		this.dataSource = dataSource;</span>
<span class="nc" id="L34">	}</span>

<span class="nc" id="L36">	RecomFeedbackService recomFeedbackService = new RecomFeedbackServiceImpl();</span>

	@Override
	public void configure() {
<span class="nc" id="L40">		restConfiguration().component(&quot;servlet&quot;).bindingMode(RestBindingMode.json);</span>

<span class="nc" id="L42">		rest(&quot;/retrieve&quot;).get().param().name(&quot;parentCustNum&quot;).type(RestParamType.query).required(true).endParam()</span>
<span class="nc" id="L43">				.param().name(&quot;productLines&quot;).type(RestParamType.query).required(true).endParam()</span>
<span class="nc" id="L44">				.outType(RecomFeedback.class).to(&quot;direct:select&quot;);</span>

<span class="nc" id="L46">		rest(&quot;/insert&quot;).post().param().name(&quot;feedbackHistory&quot;).type(RestParamType.query).required(true).endParam()</span>
<span class="nc" id="L47">				.produces(MediaType.APPLICATION_JSON_VALUE).type(RecomFeedbackPost.class).route().to(&quot;direct:setHeader&quot;)</span>
<span class="nc" id="L48">				.routeId(&quot;postRecomFeedbackRoute&quot;).log(&quot;--- binded ${body} ---&quot;).to(&quot;direct:validate&quot;);</span>

//		rest(&quot;/insert&quot;).post().param().name(&quot;feedbackHistory&quot;).type(RestParamType.query).required(true).endParam()
//				.produces(MediaType.APPLICATION_JSON_VALUE).type(RecomFeedbackPost.class).route()
//				.routeId(&quot;postRecomFeedbackRoute&quot;).log(&quot;--- binded ${body} ---&quot;).to(&quot;direct:insert&quot;)
//				.setHeader(Exchange.HTTP_RESPONSE_CODE, constant(201)).setBody(constant(null));

		/** Select the record */
<span class="nc" id="L56">		from(&quot;direct:select&quot;).process(new Processor() {</span>
			public void process(Exchange xchg) throws Exception {
<span class="nc" id="L58">				recomFeedbackService.selectRecomFeedback(xchg);</span>
<span class="nc" id="L59">			}</span>
<span class="nc" id="L60">		}).to(&quot;jdbc:dataSource&quot;).process(new Processor() {</span>
			public void process(Exchange xchg) throws Exception {
<span class="nc" id="L62">				List&lt;RecomFeedback&gt; recomFeedbackList = recomFeedbackService.retrieveRecomFeedback(xchg);</span>
<span class="nc" id="L63">				xchg.getIn().setBody(recomFeedbackList);</span>
<span class="nc" id="L64">			}</span>
		});
		;

<span class="nc" id="L68">		from(&quot;direct:setHeader&quot;).process(new Processor() {</span>
			public void process(Exchange xchg) throws Exception {
<span class="nc" id="L70">				RecomFeedbackPost recomFeedback = xchg.getIn().getBody(RecomFeedbackPost.class);</span>
<span class="nc" id="L71">				xchg.getIn().setHeader(&quot;parentCustNum&quot;, recomFeedback.getParentCustNum());</span>
<span class="nc" id="L72">				xchg.getIn().setHeader(&quot;productLines&quot;, recomFeedback.getProductLines());</span>
<span class="nc" id="L73">			}</span>
		});

		/** Validate request */
<span class="nc" id="L77">		from(&quot;direct:validate&quot;).process(new Processor() {</span>
			public void process(Exchange xchg) throws Exception {
<span class="nc" id="L79">				xchg.getIn().setHeader(&quot;isValid&quot;, recomFeedbackService.isRequestValid(xchg));</span>
//				log.info(&quot;body : &quot; + xchg.getIn().getBody());
//				log.info(&quot;validate&quot;);
<span class="nc" id="L82">			}</span>
<span class="nc" id="L83">		}).choice().when(header(&quot;isValid&quot;)).to(&quot;direct:insertValidated&quot;).otherwise()</span>
<span class="nc" id="L84">				.to(&quot;direct:printErrorResponseMessage&quot;);</span>

<span class="nc" id="L86">		from(&quot;direct:insertValidated&quot;).multicast().to(&quot;direct:insert&quot;, &quot;direct:getReturnId&quot;);</span>

		/** Insert the record */
<span class="nc" id="L89">		from(&quot;direct:insert&quot;).process(new Processor() {</span>
			public void process(Exchange xchg) throws Exception {
<span class="nc" id="L91">				recomFeedbackService.insertRecomFeedback(xchg);</span>
<span class="nc" id="L92">			}</span>
<span class="nc" id="L93">		}).to(&quot;jdbc:dataSource&quot;);</span>

		/** Get return id */
<span class="nc" id="L96">		from(&quot;direct:getReturnId&quot;).process(new Processor() {</span>
			public void process(Exchange xchg) throws Exception {
//				log.info(&quot;isValid : &quot; + xchg.getIn().getHeader(&quot;isValid&quot;));
<span class="nc" id="L99">				recomFeedbackService.returnId(xchg);</span>
<span class="nc" id="L100">			}</span>
<span class="nc" id="L101">		}).to(&quot;jdbc:dataSource&quot;).process(new Processor() {</span>
			public void process(Exchange xchg) throws Exception {
<span class="nc" id="L103">				String feedbackId = xchg.getIn().getBody(String.class).replaceAll(&quot;\\D+&quot;, &quot;&quot;);</span>
<span class="nc" id="L104">				xchg.getIn().setHeader(&quot;feedbackId&quot;, feedbackId);</span>
<span class="nc" id="L105">				log.info(&quot;feedbackId : &quot; + xchg.getIn().getHeader(&quot;feedbackId&quot;));</span>
<span class="nc" id="L106">			}</span>
<span class="nc" id="L107">		}).choice().when(header(&quot;feedbackHistory&quot;).isEqualTo(&quot;T&quot;)).to(&quot;direct:getFeedbackHistory&quot;).endChoice()</span>
<span class="nc" id="L108">				.otherwise().to(&quot;direct:printSuccessResponseMessage&quot;);</span>

		/** Get feedback history */
<span class="nc" id="L111">		from(&quot;direct:getFeedbackHistory&quot;).process(new Processor() {</span>
			public void process(Exchange xchg) throws Exception {
<span class="nc" id="L113">				recomFeedbackService.returnRecomFeedbackListByCust(xchg);</span>
//				log.info(&quot;direct:getFeedbackHistory : ok &quot;);
<span class="nc" id="L115">			}</span>
<span class="nc" id="L116">		}).to(&quot;jdbc:dataSource&quot;).to(&quot;direct:printSuccessResponseMessage&quot;);</span>

		/** Print success response message */
<span class="nc" id="L119">		from(&quot;direct:printSuccessResponseMessage&quot;).process(new Processor() {</span>
			public void process(Exchange xchg) throws Exception {
//				log.info(&quot;feedbackId : &quot; + xchg.getIn().getHeader(&quot;feedbackId&quot;));
<span class="nc" id="L122">				recomFeedbackService.printSuccessResponseMessage(xchg);</span>
<span class="nc" id="L123">			}</span>
		});

		/** Print error response message */
<span class="nc" id="L127">		from(&quot;direct:printErrorResponseMessage&quot;).process(new Processor() {</span>
			public void process(Exchange xchg) throws Exception {
<span class="nc" id="L129">				recomFeedbackService.printErrorResponseMessage(xchg);</span>
<span class="nc" id="L130">			}</span>
<span class="nc" id="L131">		}).setHeader(Exchange.HTTP_RESPONSE_CODE, constant(ErrorResponseUtil.STATUS_CODE_MANDATORY));</span>
<span class="nc" id="L132">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>